<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Metadata Page</title>
</head>

<body>
<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/metadata.css') }}">


<script src="{{ url_for('static', filename='js/get_api.js') }}"></script>

<div id="artist-wall" class="artist-wall">
    <div class="loading">正在加载专辑数据...</div>
</div>

<!-- 模态框 -->
<div id="editModal" class="modal">
    <div class="modal-content">
        <h2>编辑专辑信息</h2>
        <form id="editForm">
            <input type="hidden" id="artistId">
            <div class="form-group">
                <label for="albumname">专辑名称:</label>
                <input type="text" id="albumname" required>
            </div>
            <div class="form-group">
                <label for="artistname">艺术家名称:</label>
                <input type="text" id="artistname" required>
            </div>
            <div class="form-group">
                <label for="year">专辑发行日期:</label>
                <input type="text" id="year" required>
            </div>
            <div class="form-group">
                <label>曲目列表:</label>
                <div id="trackList" style="max-height: 200px; overflow-y: auto; border: 1px solid #ccc; padding: 10px;">
                    <!-- 曲目将动态添加到这里 -->
                     <div>正在加载曲目...</div>
                </div>
            </div>
            <div class="form-actions">
                <button type="submit" class="btn-primary">保存</button>
                <button type="button" class="btn-secondary" onclick="closeModal()">取消</button>
            </div>
        </form>
    </div>
</div>

<div id="successToast" class="toast">
    <div class="toast-content">
        <i class="toast-icon">✓</i>
        <span class="toast-message">保存成功！</span>
    </div>
</div>
<script>
all_album = []
let isLoading = false;
let offset = 0;
const pageSize = 100;
password = "&v=1.15.0&c=web";
albumurl = {{ url_for('api.album_list_id3')|tojson }};
albumidurl = {{ url_for('api.album_info')|tojson }};
async function loadData() {
    try {
        //  第一步：获取专辑
        const new_rawalbum = await getAlbum(albumurl, pageSize, offset, password);
        all_album = all_album.concat(new_rawalbum);
        console.log('Total albums loaded:', all_album.length);
        image_base_url = {{ url_for('api.cover_art')|tojson }} ;
        console.log('Image base URL:', image_base_url);
        
        // 第二步获取专辑图片的链接，添加到专辑数组里面
        for (const album of all_album) {
            const image_url = `${image_base_url}?id=al-${album.id}${password}`;
            album.image = image_url;
        }

        
        // 第三步：渲染页面
        renderPage(all_album);

    } catch (error) {
        console.error('Error loading data:', error);
        document.getElementById('artist-wall').innerHTML = 
            '<div style="text-align:center;color:red;padding:30px;">加载数据时出错：' + error.message + '</div>';
    }
}

// 检测是否滚动到底部
function isScrolledToBottom() {
    const container = document.getElementById('artist-wall');
    const cards = container.querySelectorAll('.album-card');
    
    if (cards.length === 0) return false;
    
    // 计算平均卡片高度
    const firstCard = cards[0];
    const cardHeight = firstCard.offsetHeight;
    
    // 当剩余少于 20 张卡片的高度时触发
    const triggerThreshold = cardHeight * 20;
    
    const scrollTop = window.scrollY || document.documentElement.scrollTop;
    const windowHeight = window.innerHeight;
    const documentHeight = document.documentElement.scrollHeight;
    
    return scrollTop + windowHeight >= documentHeight - triggerThreshold;
}

// 滚动事件处理
window.addEventListener('scroll', async () => {
    if (isScrolledToBottom() && !isLoading) {
        isLoading = true;
        offset += pageSize;
        try {
            const new_rawalbum = await getAlbum(albumurl, pageSize, offset, password);
            if (new_rawalbum && new_rawalbum.length > 0) {
                // 添加图片链接
                for (const album of new_rawalbum) {
                    const image_url = `${image_base_url}?id=al-${album.id}${password}`;
                    album.image = image_url;
                }
                all_album = all_album.concat(new_rawalbum);
                renderPage(all_album);
            }
        } catch (error) {
            console.error('加载更多数据失败:', error);
        } finally {
            isLoading = false;
        }
    }
});



function renderPage(album_array) {
    const container = document.getElementById('artist-wall');
    if (container.querySelector('.loading')) {
        container.innerHTML = ''; // 清空加载提示
    }
    
    // 创建艺术家卡片
    for (const album of album_array) {
        if (album.hasrendered) {
            continue; // 跳过已经渲染过的专辑
        }
        const card = document.createElement('div');
        card.className = 'album-card';
        // 添加点击事件
        card.onclick = () => openEditModal(album);


        // 创建一个包装容器
        const imgContainer = document.createElement('div');
        imgContainer.className = 'image-container';
        
        // 创建默认显示
        const placeholder = document.createElement('div');
        placeholder.className = 'placeholder';
        const firstChar = (album.name && album.name.length > 0) ? 
                          album.name[0].toUpperCase() : '?';
        placeholder.textContent = firstChar;
        imgContainer.appendChild(placeholder);
        
        // 创建实际图片元素
        const img = document.createElement('img');
        img.className = 'artist-image'; // 使用相同的类名以应用相同的样式
        album.hasrendered = true;
        img.src = album.image;
        img.alt = album.name;
        img.onload = () => {
            // 图片加载成功时，隐藏占位符
            placeholder.style.display = 'none';
        };
        img.onerror = () => {
            // 图片加载失败时，保持显示占位符
            img.style.display = 'none';
        };
        imgContainer.appendChild(img);
        
        const name = document.createElement('div');
        name.className = 'artist-name'; // 使用相同的类名以应用相同的样式
        name.textContent = album.name;
        
        card.appendChild(imgContainer);
        card.appendChild(name);
        container.appendChild(card);
    }
}

// 添加模态框相关函数
function openEditModal(album) {
    const modal = document.getElementById('editModal');
    const albumname = document.getElementById('albumname');
    const artistname = document.getElementById('artistname');
    const year = document.getElementById('year');
    const trackList = document.getElementById('trackList');
    // 填充表单数据
    albumname.value = album.name;
    albumid = album.id;
    artistname.value = album.artist;
    year.value = album.year || '';
    modal.style.display = 'block';
    trackList.innerHTML = ''; // 清空之前的曲目列表
    album_info = getAlbumByid(albumid,password, albumidurl);
    album_info.then(data => {
        raw_data = data;
        const tracks = data.song || [];
        if (tracks.length === 0) {
            trackList.innerHTML = '<div>无曲目数据</div>';
        } else {
            for (const track of tracks) {
                const trackItem = document.createElement('div');
                trackItem.textContent = `${track.track}. ${track.title}`;
                trackList.appendChild(trackItem);
            }
        }
    });
}

function showSuccessToast(message = '保存成功！') {
    const toast = document.getElementById('successToast');
    const messageEl = toast.querySelector('.toast-message');
    messageEl.textContent = message;
    
    // 显示提示框
    toast.style.display = 'block';
    
    // 3秒后自动关闭
    setTimeout(() => {
        toast.style.animation = 'fadeOut 0.3s ease';
        setTimeout(() => {
            toast.style.display = 'none';
            toast.style.animation = '';
        }, 300);
    }, 3000);
}


// 添加表单提交处理
document.getElementById('editForm').onsubmit = async function(e) {
    e.preventDefault();
    
    const artistId = document.getElementById('artistId').value;
    const artistName = document.getElementById('artistName').value;
    const realArtist = document.getElementById('realArtist').value.trim();
    
    try {
        // 构建请求数据
        const requestData = {
            action: 'change_real_artist',
            id: artistId,
            name: artistName,
            real_name: realArtist || null  // 如果为空字符串则设为 null
        };
        const response = await fetch('/artists', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestData)
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.message || '保存失败');
        }
        const successData = await response.json();
        // 保存成功
        closeModal();
        // 重新加载数据以显示更新后的结果
        showSuccessToast(successData.message);
        loadData();
        
    } catch (error) {
        console.error('保存失败:', error);
        alert('保存失败: ' + error.message);
    }
};

function closeModal() {
    const modal = document.getElementById('editModal');
    modal.style.display = 'none';
}




// 点击模态框外部关闭
window.onclick = function(event) {
    const modal = document.getElementById('editModal');
    if (event.target === modal) {
        closeModal();
    }
};

// 调用主函数开始顺序执行
loadData();
</script>
</body>
</html>